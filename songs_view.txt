CREATE VIEW spotify.songs AS
select min(t.track_id) track_id,t.name,count(t.track_id) versions, avg(t.acousticness) acousticness, avg(t.danceability) danceability, avg(t.duration_ms)/1000 duration_sec, avg(t.energy) energy, avg(t.instrumentalness) instrumentalness, t.music_key, avg(t.liveness) liveness, avg(t.loudness) loudness, t.mode, avg(t.speechiness) speechiness, avg(t.tempo) tempo, t.time_signature, avg(t.valence) valence, max(t.is_explicit) is_explicit, max(t.popularity) popularity, min(al.release_date) date, a1.artist_id first_artist, null second_artist, null third_artist, null fourth_artist
from d_tracks t inner join albums al on t.album_id=al.album_id inner join track_artists a1 on t.track_id=a1.track_id 
where 1=(select count(distinct artist_id) from track_artists where track_id=t.track_id group by track_id) group by t.name,first_artist
union 
select min(t.track_id),t.name,count(t.track_id), avg(t.acousticness), avg(t.danceability), avg(t.duration_ms)/1000, avg(t.energy), avg(t.instrumentalness), t.music_key, avg(t.liveness), avg(t.loudness), t.mode, avg(t.speechiness), avg(t.tempo), t.time_signature, avg(t.valence), max(t.is_explicit), max(t.popularity), min(al.release_date), a1.artist_id first_artist, a2.artist_id second_artist, null third_artist, null fourth_artist
from d_tracks t inner join albums al on t.album_id=al.album_id inner join track_artists a1 on t.track_id=a1.track_id inner join track_artists a2 on t.track_id=a2.track_id 
where 2=(select count(distinct artist_id) from track_artists where track_id=t.track_id group by track_id) and a1.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1) and a2.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1,1) group by t.name,first_artist,second_artist
union
select min(t.track_id),t.name,count(t.track_id), avg(t.acousticness), avg(t.danceability), avg(t.duration_ms)/1000, avg(t.energy), avg(t.instrumentalness), t.music_key, avg(t.liveness), avg(t.loudness), t.mode, avg(t.speechiness), avg(t.tempo), t.time_signature, avg(t.valence), max(t.is_explicit), max(t.popularity),min(al.release_date),a1.artist_id first_artist,a2.artist_id second_artist,a3.artist_id third_artist, null fourth_artist
from d_tracks t inner join albums al on t.album_id=al.album_id inner join track_artists a1 on
t.track_id=a1.track_id inner join track_artists a2 on t.track_id=a2.track_id inner join track_artists a3 on t.track_id=a3.track_id
where 3=(select count(distinct artist_id) from track_artists where track_id=t.track_id group by track_id) and a1.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1) and a2.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1,1) and a3.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 2,1) group by t.name,first_artist,second_artist,third_artist
union
select min(t.track_id),t.name,count(t.track_id), avg(t.acousticness), avg(t.danceability), avg(t.duration_ms)/1000, avg(t.energy), avg(t.instrumentalness), t.music_key, avg(t.liveness), avg(t.loudness), t.mode, avg(t.speechiness), avg(t.tempo), t.time_signature, avg(t.valence), max(t.is_explicit), max(t.popularity),min(al.release_date),a1.artist_id first_artist,a2.artist_id second_artist,a3.artist_id third_artist,a4.artist_id fourth_artist
from d_tracks t inner join albums al on t.album_id=al.album_id inner join track_artists a1 on
t.track_id=a1.track_id inner join track_artists a2 on t.track_id=a2.track_id inner join track_artists a3 on t.track_id=a3.track_id inner join track_artists a4 on t.track_id=a4.track_id
where 4=(select count(distinct artist_id) from track_artists where track_id=t.track_id group by track_id) and a1.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1) and a2.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 1,1) and a3.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 2,1) and
a4.artist_id=(select artist_id from track_artists where track_id=t.track_id order by artist_id limit 3,1) group by t.name,first_artist,second_artist,third_artist,fourth_artist